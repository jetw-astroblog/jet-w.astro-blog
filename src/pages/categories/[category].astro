---
import { getCollection } from 'astro:content';
import PageLayout from '@jet-w/astro-blog/layouts/PageLayout.astro';
import PostCard from '@jet-w/astro-blog/components/blog/PostCard.astro';
import Pagination from '@jet-w/astro-blog/components/ui/Pagination.astro';
import { i18nConfig as virtualI18nConfig } from 'virtual:astro-blog-i18n';
import { defaultI18nConfig } from '../../config/i18n';
import { getLocaleFromPath, getLocaleConfig, getLocalePrefix, filterPostsByLocale } from '../../utils/i18n';

export async function getStaticPaths() {
  const allPosts = await getCollection('posts', ({ data }) => !data.draft);

  // ä»æ‰€æœ‰æ–‡ç« ä¸­æ”¶é›†åˆ†ç±»
  const categoryMap = new Map<string, { name: string; count: number }>();

  allPosts.forEach(post => {
    (post.data.categories || []).forEach(category => {
      const slug = category.toLowerCase().replace(/\s+/g, '-');
      if (categoryMap.has(slug)) {
        categoryMap.get(slug)!.count++;
      } else {
        categoryMap.set(slug, { name: category, count: 1 });
      }
    });
  });

  // ä¸ºæ¯ä¸ªåˆ†ç±»ç”Ÿæˆè·¯å¾„
  return Array.from(categoryMap.entries()).map(([slug, { name, count }]) => ({
    params: { category: slug },
    props: { categorySlug: slug, categoryName: name, categoryCount: count }
  }));
}

const { categorySlug, categoryName } = Astro.props;

// Get i18n config
const i18nConfig = virtualI18nConfig || defaultI18nConfig;
const currentLocale = getLocaleFromPath(Astro.url.pathname, i18nConfig);
const localeConfig = getLocaleConfig(currentLocale, i18nConfig);
const ui = localeConfig.ui;
const base = import.meta.env.BASE_URL;
const localePrefix = getLocalePrefix(currentLocale, i18nConfig, base);

// è·å–æ‰€æœ‰æ–‡ç« å¹¶ç­›é€‰åŒ…å«è¯¥åˆ†ç±»çš„æ–‡ç« 
const allPostsCollection = await getCollection('posts', ({ data }) => !data.draft);

// Filter posts by current locale
const allPosts = filterPostsByLocale(allPostsCollection, currentLocale, i18nConfig);

// ç­›é€‰åŒ…å«è¯¥åˆ†ç±»çš„æ–‡ç« 
const filteredPosts = allPosts
  .filter(post =>
    (post.data.categories || []).some(c => c.toLowerCase().replace(/\s+/g, '-') === categorySlug)
  )
  .sort((a, b) => {
    const dateA = a.data.pubDate ? new Date(a.data.pubDate).getTime() : 0;
    const dateB = b.data.pubDate ? new Date(b.data.pubDate).getTime() : 0;
    return dateB - dateA;
  });

// åˆ†é¡µé€»è¾‘
const currentPage = 1;
const postsPerPage = 10;
const totalPosts = filteredPosts.length;
const totalPages = Math.ceil(totalPosts / postsPerPage);
const startIndex = (currentPage - 1) * postsPerPage;
const endIndex = startIndex + postsPerPage;
const posts = filteredPosts.slice(startIndex, endIndex);

// è·å–ç›¸å…³åˆ†ç±»ï¼ˆåŒä¸€ç¯‡æ–‡ç« ä¸­å‡ºç°çš„å…¶ä»–åˆ†ç±»ï¼‰
const relatedCategoryMap = new Map<string, { name: string; count: number }>();
filteredPosts.forEach(post => {
  (post.data.categories || []).forEach(cat => {
    const slug = cat.toLowerCase().replace(/\s+/g, '-');
    if (slug !== categorySlug) {
      if (relatedCategoryMap.has(slug)) {
        relatedCategoryMap.get(slug)!.count++;
      } else {
        relatedCategoryMap.set(slug, { name: cat, count: 1 });
      }
    }
  });
});

const relatedCategories = Array.from(relatedCategoryMap.entries())
  .sort((a, b) => b[1].count - a[1].count)
  .slice(0, 3)
  .map(([slug, { name, count }]) => ({ slug, name, count }));
---

<PageLayout
  title={`${ui.inCategory}: ${categoryName}`}
  description={`${ui.inCategory} ${categoryName}`}
  showSidebar={true}
  i18nConfig={i18nConfig}
>
  <!-- é¢åŒ…å±‘å¯¼èˆª -->
  <nav class="flex items-center space-x-2 text-sm text-slate-600 dark:text-slate-400 mb-8">
    <a href={`${localePrefix}/`} class="hover:text-primary-500 transition-colors">{ui.home}</a>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
    </svg>
    <a href={`${localePrefix}/categories`} class="hover:text-primary-500 transition-colors">{ui.allCategories}</a>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
    </svg>
    <span class="text-slate-900 dark:text-slate-100">{categoryName}</span>
  </nav>

  <!-- é¡µé¢å¤´éƒ¨ -->
  <div class="text-center mb-12">
    <div class="inline-flex items-center justify-center w-20 h-20 bg-amber-100 dark:bg-amber-900/30 rounded-full mb-6">
      <svg class="w-10 h-10 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
      </svg>
    </div>

    <h1 class="text-4xl font-bold text-slate-900 dark:text-slate-100 mb-4">
      {categoryName}
    </h1>

    <p class="text-xl text-slate-600 dark:text-slate-400 mb-8 max-w-2xl mx-auto">
      {totalPosts} {ui.posts}
    </p>

    <!-- åˆ†ç±»ç»Ÿè®¡ -->
    <div class="inline-flex items-center space-x-6 text-sm text-slate-500 dark:text-slate-400 bg-slate-50 dark:bg-slate-800 px-6 py-3 rounded-lg">
      <span>{categoryName}</span>
      <span>â€¢</span>
      <span>{totalPosts} {ui.posts}</span>
      {totalPages > 1 && (
        <>
          <span>â€¢</span>
          <span>{totalPages} {ui.page}</span>
        </>
      )}
    </div>
  </div>

  <!-- æ–‡ç« åˆ—è¡¨ -->
  {posts.length > 0 ? (
    <div class="space-y-8 mb-12">
      {posts.map((post) => (
        <PostCard
          post={{
            slug: post.id.toLowerCase(),
            title: post.data.title,
            description: post.data.description,
            pubDate: post.data.pubDate,
            tags: post.data.tags,
            categories: post.data.categories,
            author: post.data.author,
            image: post.data.image
          }}
          layout="horizontal"
          localePrefix={localePrefix}
          locale={localeConfig.locale.dateLocale}
          ui={ui}
        />
      ))}
    </div>
  ) : (
    <div class="text-center py-16">
      <div class="text-6xl mb-4">ğŸ“‚</div>
      <h3 class="text-xl font-semibold text-slate-900 dark:text-slate-100 mb-2">
        {ui.noPostsFound}
      </h3>
      <p class="text-slate-600 dark:text-slate-400 mb-6">
        {ui.noPostsFound}
      </p>
      <a href={`${localePrefix}/categories`} class="btn-secondary">
        {ui.allCategories}
      </a>
    </div>
  )}

  <!-- åˆ†é¡µå¯¼èˆª -->
  {totalPages > 1 && (
    <Pagination
      currentPage={currentPage}
      totalPages={totalPages}
      baseUrl={`${localePrefix}/categories/${categorySlug}`}
    />
  )}

  <!-- ç›¸å…³åˆ†ç±» -->
  {relatedCategories.length > 0 && (
    <section class="mt-16 pt-8 border-t border-slate-200 dark:border-slate-700">
      <h2 class="text-2xl font-bold text-slate-900 dark:text-slate-100 mb-6">
        {ui.categories}
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        {relatedCategories.map((relatedCategory) => (
          <a
            href={`${localePrefix}/categories/${relatedCategory.slug}`}
            class="group card hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300"
          >
            <div class="flex items-center justify-between">
              <div>
                <h3 class="font-semibold text-slate-900 dark:text-slate-100 group-hover:text-amber-500 transition-colors">
                  {relatedCategory.name}
                </h3>
                <p class="text-sm text-slate-600 dark:text-slate-400">
                  {relatedCategory.count} {ui.posts}
                </p>
              </div>
              <svg class="w-5 h-5 text-slate-400 group-hover:text-amber-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </div>
          </a>
        ))}
      </div>
    </section>
  )}
</PageLayout>
