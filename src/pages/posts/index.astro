---
import PageLayout from '@jet-w/astro-blog/layouts/PageLayout.astro';
import PostCard from '@jet-w/astro-blog/components/blog/PostCard.astro';
import Pagination from '@jet-w/astro-blog/components/ui/Pagination.astro';
import NavigationTabs from '@jet-w/astro-blog/components/blog/NavigationTabs.vue';
import { getCollection } from 'astro:content';
import { i18nConfig as virtualI18nConfig } from 'virtual:astro-blog-i18n';
import { defaultI18nConfig } from '../../config/i18n';
import { getLocaleFromPath, getLocaleConfig, getLocalePrefix, filterPostsByLocale } from '../../utils/i18n';

// Get i18n config
const i18nConfig = virtualI18nConfig || defaultI18nConfig;
const currentLocale = getLocaleFromPath(Astro.url.pathname, i18nConfig);
const localeConfig = getLocaleConfig(currentLocale, i18nConfig);
const ui = localeConfig.ui;
const base = import.meta.env.BASE_URL;
const localePrefix = getLocalePrefix(currentLocale, i18nConfig, base);

// ‰ªéÊñ∞ÁöÑÂÜÖÂÆπÁõÆÂΩïËé∑ÂèñÊñáÁ´†Êï∞ÊçÆ
const allPostsCollection = await getCollection('posts');

// Filter posts by current locale
const localeFilteredPosts = filterPostsByLocale(allPostsCollection, currentLocale, i18nConfig);

const publishedPosts = localeFilteredPosts
  .filter(post => !post.data.draft)
  .sort((a, b) => (b.data.pubDate?.getTime() ?? 0) - (a.data.pubDate?.getTime() ?? 0));

const allPosts = publishedPosts.map(post => ({
  slug: post.id.toLowerCase(),
  title: post.data.title,
  description: post.data.description,
  pubDate: post.data.pubDate,
  tags: post.data.tags,
  categories: post.data.categories,
  author: post.data.author,
  readingTime: 5,
  image: post.data.image
}));

// ÊûÑÂª∫Ê†áÁ≠æÊï∞ÊçÆ
const tagCounts: Record<string, number> = {};
allPosts.forEach(post => {
  (post.tags || []).forEach(tag => {
    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
  });
});
const tagsData = Object.entries(tagCounts)
  .map(([name, count]) => ({ name, count }))
  .sort((a, b) => b.count - a.count);

// ÊûÑÂª∫ÂàÜÁ±ªÊï∞ÊçÆ
const categoryCounts: Record<string, number> = {};
allPosts.forEach(post => {
  (post.categories || []).forEach(category => {
    categoryCounts[category] = (categoryCounts[category] || 0) + 1;
  });
});
const categoriesData = Object.entries(categoryCounts)
  .map(([name, count]) => ({ name, count }))
  .sort((a, b) => b.count - a.count);

// ÊûÑÂª∫ÂΩíÊ°£Êï∞ÊçÆ
const archiveCounts: Record<string, number> = {};
allPosts.forEach(post => {
  if (post.pubDate) {
    const year = post.pubDate.getFullYear().toString();
    const month = (post.pubDate.getMonth() + 1).toString().padStart(2, '0');
    const key = `${year}-${month}`;
    archiveCounts[key] = (archiveCounts[key] || 0) + 1;
  }
});
const archivesData = Object.entries(archiveCounts)
  .map(([key, count]) => {
    const [year, month] = key.split('-');
    return { year, month, key, count };
  })
  .sort((a, b) => b.key.localeCompare(a.key));

// ÊûÑÂª∫Êó∂Èó¥ËΩ¥Êï∞ÊçÆÔºàÊúÄËøë10ÁØáÔºâ
const timelineData = allPosts.slice(0, 10).map(post => ({
  slug: post.slug,
  title: post.title,
  pubDate: post.pubDate?.toISOString() || ''
}));

// ÊûÑÂª∫Â±ÇÁ∫ßÁªìÊûÑÔºàÁî®‰∫éÂàóË°®Ê®°ÂºèÔºâ
interface TreeNode {
  name: string;
  slug?: string;
  title?: string;
  description?: string;
  pubDate?: Date;
  children: TreeNode[];
  isFolder: boolean;
  isReadme?: boolean;
}

const buildTree = () => {
  const tree: TreeNode[] = [];
  const folderTitles: Record<string, string> = {};

  // Êî∂ÈõÜÊñá‰ª∂Â§πÊ†áÈ¢òÔºà‰ªé READMEÔºâ
  publishedPosts.forEach(post => {
    const pathParts = post.id.split('/');
    const fileName = pathParts[pathParts.length - 1].toLowerCase();
    if (fileName === 'readme' || fileName === 'readme.md') {
      const folderPath = pathParts.slice(0, -1).join('/');
      if (folderPath && post.data.title) {
        folderTitles[folderPath] = post.data.title;
      }
    }
  });

  // ÊûÑÂª∫Ê†ë
  publishedPosts.forEach(post => {
    const pathParts = post.id.split('/');
    let currentLevel = tree;
    let currentPath = '';

    pathParts.forEach((part, index) => {
      const isLast = index === pathParts.length - 1;
      currentPath = currentPath ? `${currentPath}/${part}` : part;
      const existing = currentLevel.find(n => n.name === part);
      const isReadme = isLast && (part.toLowerCase() === 'readme' || part.toLowerCase() === 'readme.md');

      if (existing) {
        if (isLast) {
          existing.slug = post.id;
          existing.title = post.data.title;
          existing.description = post.data.description;
          existing.pubDate = post.data.pubDate;
          existing.isReadme = isReadme;
        }
        currentLevel = existing.children;
      } else {
        const folderPath = pathParts.slice(0, index + 1).join('/');
        const newNode: TreeNode = {
          name: part,
          slug: isLast ? post.id : undefined,
          title: isLast ? post.data.title : folderTitles[folderPath],
          description: isLast ? post.data.description : undefined,
          pubDate: isLast ? post.data.pubDate : undefined,
          children: [],
          isFolder: !isLast,
          isReadme: isReadme
        };
        currentLevel.push(newNode);
        currentLevel = newNode.children;
      }
    });
  });

  // ÊéíÂ∫èÂπ∂ËøáÊª§ README
  const sortTree = (nodes: TreeNode[]): TreeNode[] => {
    return nodes
      .filter(node => !node.isReadme)
      .sort((a, b) => {
        if (a.isFolder && !b.isFolder) return -1;
        if (!a.isFolder && b.isFolder) return 1;
        return a.name.localeCompare(b.name, 'zh-CN', { numeric: true });
      })
      .map(node => ({
        ...node,
        children: sortTree(node.children)
      }));
  };

  return sortTree(tree);
};

const postTree = buildTree();

// ÂàÜÈ°µÈÄªËæë
const currentPage = 1;
const postsPerPage = 10;
const totalPosts = allPosts.length;
const totalPages = Math.ceil(totalPosts / postsPerPage);
const startIndex = (currentPage - 1) * postsPerPage;
const endIndex = startIndex + postsPerPage;
const posts = allPosts.slice(startIndex, endIndex);

// Ëé∑ÂèñÊâÄÊúâÊ†áÁ≠æÂíåÂàÜÁ±ªÁî®‰∫éÁ≠õÈÄâ
const allTags = [...new Set(allPosts.flatMap(post => post.tags || []))];
const allCategories = [...new Set(allPosts.flatMap(post => post.categories || []))];

// Ê†ºÂºèÂåñÊó•Êúü
const formatDateLocal = (date?: Date) => {
  if (!date) return '';
  return new Intl.DateTimeFormat(localeConfig.locale.dateLocale, {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  }).format(date);
};
---

<PageLayout
  title={ui.postList}
  description={localeConfig.site.description}
  showSidebar={true}
  i18nConfig={i18nConfig}
>
  <!-- Èù¢ÂåÖÂ±ëÂØºËà™ -->
  <nav class="flex items-center space-x-2 text-sm text-slate-600 dark:text-slate-400 mb-8">
    <a href={`${localePrefix}/`} class="hover:text-primary-500 transition-colors">{ui.home}</a>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
    </svg>
    <span class="text-slate-900 dark:text-slate-100">{ui.postList}</span>
  </nav>

  <!-- È°µÈù¢Â§¥ÈÉ® -->
  <div class="mb-12">
    <div class="text-center">
      <h1 class="text-4xl font-bold text-slate-900 dark:text-slate-100 mb-4">
        {ui.postList}
      </h1>
      <p class="text-xl text-slate-600 dark:text-slate-400 mb-8">
        {localeConfig.site.description}
      </p>

      <!-- ÁªüËÆ°‰ø°ÊÅØ -->
      <div class="inline-flex items-center space-x-6 text-sm text-slate-500 dark:text-slate-400 bg-slate-50 dark:bg-slate-800 px-6 py-3 rounded-lg">
        <span>{totalPosts} {ui.posts}</span>
        <span>‚Ä¢</span>
        <span>{allTags.length} {ui.tags}</span>
        <span>‚Ä¢</span>
        <span>{allCategories.length} {ui.categories}</span>
      </div>
    </div>
  </div>

  <!-- ÂØºËà™Ê†áÁ≠æÂç°Áâá
  <div class="mb-8">
    <NavigationTabs
      client:load
      tags={tagsData}
      archives={archivesData}
      categories={categoriesData}
      timeline={timelineData}
    />
  </div> -->

  <!-- Á≠õÈÄâÂô® -->
  <div class="mb-8 p-6 bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- ÊåâÊ†áÁ≠æÁ≠õÈÄâ -->
      <div>
        <h3 class="text-sm font-semibold text-slate-900 dark:text-slate-100 mb-3">
          {ui.filterByTag}
        </h3>
        <div class="flex flex-wrap gap-2">
          <a href={`${localePrefix}/tags`} class="px-3 py-1 text-xs rounded-full bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300 hover:bg-primary-200 dark:hover:bg-primary-900/50 transition-colors">
            {ui.allTags}
          </a>
          {allTags.slice(0, 10).map((tag) => (
            <a href={`${localePrefix}/tags/${tag.toLowerCase().replace(/\s+/g, '-')}`} class="px-3 py-1 text-xs rounded-full bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
              {tag}
            </a>
          ))}
          {allTags.length > 10 && (
            <a href={`${localePrefix}/tags`} class="px-3 py-1 text-xs rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
              +{allTags.length - 10}
            </a>
          )}
        </div>
      </div>

      <!-- ÊåâÂàÜÁ±ªÁ≠õÈÄâ -->
      <div>
        <h3 class="text-sm font-semibold text-slate-900 dark:text-slate-100 mb-3">
          {ui.filterByCategory}
        </h3>
        <div class="flex flex-wrap gap-2">
          <a href={`${localePrefix}/categories`} class="px-3 py-1 text-xs rounded-full bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300 hover:bg-primary-200 dark:hover:bg-primary-900/50 transition-colors">
            {ui.allCategories}
          </a>
          {allCategories.slice(0, 8).map((category) => (
            <a href={`${localePrefix}/categories/${category.toLowerCase().replace(/\s+/g, '-')}`} class="px-3 py-1 text-xs rounded-full bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
              {category}
            </a>
          ))}
          {allCategories.length > 8 && (
            <a href={`${localePrefix}/categories`} class="px-3 py-1 text-xs rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
              +{allCategories.length - 8}
            </a>
          )}
        </div>
      </div>
    </div>
  </div>

  <!-- ÊñáÁ´†ÂàóË°®Âå∫Âüü -->
  <div class="mb-12">
    <!-- ËßÜÂõæÂàáÊç¢ÊåâÈíÆ -->
    <div class="flex items-center justify-end mb-4">
      <div class="flex items-center gap-2 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
        <button
          class="view-toggle-btn active px-3 py-1.5 text-sm rounded-md transition-colors"
          data-view="card"
          title="Âç°ÁâáÊ®°Âºè"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
          </svg>
        </button>
        <button
          class="view-toggle-btn px-3 py-1.5 text-sm rounded-md transition-colors"
          data-view="list"
          title="ÂàóË°®Ê®°Âºè"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Âç°ÁâáÊ®°Âºè -->
    <div id="card-view" class="view-container">
    {posts.length > 0 ? (
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-12">
        {posts.map((post) => (
          <PostCard post={post} layout="horizontal" localePrefix={localePrefix} locale={localeConfig.locale.dateLocale} ui={ui} />
        ))}
      </div>
    ) : (
      <div class="text-center py-16">
        <div class="text-6xl mb-4">üìù</div>
        <h3 class="text-xl font-semibold text-slate-900 dark:text-slate-100 mb-2">
          {ui.noPostsFound}
        </h3>
        <p class="text-slate-600 dark:text-slate-400">
          {ui.noPostsFound}
        </p>
      </div>
    )}
  </div>

  <!-- ÂàóË°®Ê®°Âºè -->
  <div id="list-view" class="view-container hidden">
    {postTree.length > 0 ? (
      <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden mb-12">
        <div class="post-tree">
          {postTree.map((node) => (
            <div class="tree-node">
              {node.isFolder ? (
                <div class="folder-node">
                  <button class="folder-toggle w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors border-b border-slate-100 dark:border-slate-700">
                    <svg class="folder-chevron w-4 h-4 text-slate-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                    <svg class="w-5 h-5 text-amber-500" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M10 4H4a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V8a2 2 0 00-2-2h-8l-2-2z" />
                    </svg>
                    <span class="font-medium text-slate-900 dark:text-slate-100">{node.title || node.name}</span>
                    <span class="text-xs text-slate-400 ml-auto">{node.children.length} ÁØá</span>
                  </button>
                  <div class="folder-children hidden">
                    {node.children.map((child) => (
                      <div class="tree-node">
                        {child.isFolder ? (
                          <div class="folder-node ml-6">
                            <button class="folder-toggle w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors border-b border-slate-100 dark:border-slate-700">
                              <svg class="folder-chevron w-4 h-4 text-slate-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                              </svg>
                              <svg class="w-5 h-5 text-amber-500" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M10 4H4a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V8a2 2 0 00-2-2h-8l-2-2z" />
                              </svg>
                              <span class="font-medium text-slate-900 dark:text-slate-100">{child.title || child.name}</span>
                              <span class="text-xs text-slate-400 ml-auto">{child.children.length} ÁØá</span>
                            </button>
                            <div class="folder-children hidden">
                              {child.children.map((grandChild) => (
                                <a
                                  href={`${localePrefix}/posts/${grandChild.slug}`}
                                  class="ml-12 flex items-start gap-4 px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors border-b border-slate-100 dark:border-slate-700 group"
                                >
                                  <svg class="w-4 h-4 text-slate-400 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                  </svg>
                                  <div class="flex-1 min-w-0">
                                    <h4 class="font-medium text-slate-900 dark:text-slate-100 group-hover:text-primary-500 transition-colors">{grandChild.title || grandChild.name}</h4>
                                    {grandChild.description && (
                                      <p class="text-sm text-slate-500 dark:text-slate-400 mt-1 line-clamp-1">{grandChild.description}</p>
                                    )}
                                  </div>
                                  {grandChild.pubDate && (
                                    <time class="text-xs text-slate-400 flex-shrink-0">{formatDateLocal(grandChild.pubDate)}</time>
                                  )}
                                </a>
                              ))}
                            </div>
                          </div>
                        ) : (
                          <a
                            href={`${localePrefix}/posts/${child.slug}`}
                            class="ml-6 flex items-start gap-4 px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors border-b border-slate-100 dark:border-slate-700 group"
                          >
                            <svg class="w-4 h-4 text-slate-400 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <div class="flex-1 min-w-0">
                              <h4 class="font-medium text-slate-900 dark:text-slate-100 group-hover:text-primary-500 transition-colors">{child.title || child.name}</h4>
                              {child.description && (
                                <p class="text-sm text-slate-500 dark:text-slate-400 mt-1 line-clamp-1">{child.description}</p>
                              )}
                            </div>
                            {child.pubDate && (
                              <time class="text-xs text-slate-400 flex-shrink-0">{formatDateLocal(child.pubDate)}</time>
                            )}
                          </a>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              ) : (
                <a
                  href={`${localePrefix}/posts/${node.slug}`}
                  class="flex items-start gap-4 px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors border-b border-slate-100 dark:border-slate-700 group"
                >
                  <svg class="w-4 h-4 text-slate-400 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  <div class="flex-1 min-w-0">
                    <h4 class="font-medium text-slate-900 dark:text-slate-100 group-hover:text-primary-500 transition-colors">{node.title || node.name}</h4>
                    {node.description && (
                      <p class="text-sm text-slate-500 dark:text-slate-400 mt-1 line-clamp-1">{node.description}</p>
                    )}
                  </div>
                  {node.pubDate && (
                    <time class="text-xs text-slate-400 flex-shrink-0">{formatDateLocal(node.pubDate)}</time>
                  )}
                </a>
              )}
            </div>
          ))}
        </div>
      </div>
    ) : (
      <div class="text-center py-16">
        <div class="text-6xl mb-4">üìù</div>
        <h3 class="text-xl font-semibold text-slate-900 dark:text-slate-100 mb-2">
          {ui.noPostsFound}
        </h3>
        <p class="text-slate-600 dark:text-slate-400">
          {ui.noPostsFound}
        </p>
      </div>
    )}
  </div>
  </div>

  <!-- ÂàÜÈ°µÂØºËà™Ôºà‰ªÖÂç°ÁâáÊ®°ÂºèÊòæÁ§∫Ôºâ -->
  <div id="pagination-container">
    {totalPages > 1 && (
      <Pagination
        currentPage={currentPage}
        totalPages={totalPages}
        baseUrl={`${localePrefix}/posts`}
      />
    )}
  </div>
</PageLayout>

<style>
  .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .view-toggle-btn {
    @apply text-slate-500 dark:text-slate-400;
  }

  .view-toggle-btn.active {
    @apply bg-white dark:bg-slate-600 text-primary-600 dark:text-primary-400 shadow-sm;
  }

  .view-toggle-btn:not(.active):hover {
    @apply text-slate-700 dark:text-slate-200;
  }

  .folder-toggle.expanded .folder-chevron {
    transform: rotate(90deg);
  }

  .folder-children.show {
    display: block;
  }
</style>

<script>
  function initViewToggle() {
    const toggleBtns = document.querySelectorAll('.view-toggle-btn');
    const cardView = document.getElementById('card-view');
    const listView = document.getElementById('list-view');
    const pagination = document.getElementById('pagination-container');

    // ‰ªé localStorage ÊÅ¢Â§çËßÜÂõæÊ®°Âºè
    const savedView = localStorage.getItem('posts-view-mode') || 'card';
    setView(savedView);

    toggleBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const view = btn.getAttribute('data-view');
        if (view) {
          setView(view);
          localStorage.setItem('posts-view-mode', view);
        }
      });
    });

    function setView(view: string) {
      toggleBtns.forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-view') === view);
      });

      if (cardView && listView && pagination) {
        if (view === 'card') {
          cardView.classList.remove('hidden');
          listView.classList.add('hidden');
          pagination.classList.remove('hidden');
        } else {
          cardView.classList.add('hidden');
          listView.classList.remove('hidden');
          pagination.classList.add('hidden');
        }
      }
    }

    // Êñá‰ª∂Â§πÂ±ïÂºÄ/Êî∂Ëµ∑
    const folderToggles = document.querySelectorAll('.folder-toggle');
    folderToggles.forEach(toggle => {
      toggle.addEventListener('click', () => {
        const children = toggle.nextElementSibling;
        const isExpanded = toggle.classList.toggle('expanded');

        if (children && children.classList.contains('folder-children')) {
          children.classList.toggle('show', isExpanded);
        }
      });
    });

    // ÈªòËÆ§Â±ïÂºÄÁ¨¨‰∏ÄÂ±ÇÊñá‰ª∂Â§π
    const firstLevelToggles = document.querySelectorAll('.post-tree > .tree-node > .folder-node > .folder-toggle');
    firstLevelToggles.forEach(toggle => {
      if (!toggle.classList.contains('expanded')) {
        (toggle as HTMLElement).click();
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initViewToggle);
  } else {
    initViewToggle();
  }
</script>
