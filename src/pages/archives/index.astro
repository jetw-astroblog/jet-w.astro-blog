---
import { getCollection } from 'astro:content';
import PageLayout from '@jet-w/astro-blog/layouts/PageLayout.astro';
import { i18nConfig as virtualI18nConfig } from 'virtual:astro-blog-i18n';
import { defaultI18nConfig } from '../../config/i18n';
import { getLocaleFromPath, getLocaleConfig, getLocalePrefix, filterPostsByLocale } from '../../utils/i18n';

// Get i18n config
const i18nConfig = virtualI18nConfig || defaultI18nConfig;
const currentLocale = getLocaleFromPath(Astro.url.pathname, i18nConfig);
const localeConfig = getLocaleConfig(currentLocale, i18nConfig);
const ui = localeConfig.ui;
const base = import.meta.env.BASE_URL;
const localePrefix = getLocalePrefix(currentLocale, i18nConfig, base);

// è·å–æ‰€æœ‰éè‰ç¨¿æ–‡ç« 
const allPostsCollection = await getCollection('posts', ({ data }) => !data.draft);

// Filter posts by current locale
const allPosts = filterPostsByLocale(allPostsCollection, currentLocale, i18nConfig);

// æŒ‰å¹´æœˆåˆ†ç»„æ–‡ç« 
interface ArchiveMonth {
  month: number;
  monthName: string;
  count: number;
  posts: Array<{
    id: string;
    title: string;
    pubDate: Date;
  }>;
}

interface ArchiveYear {
  year: number;
  months: ArchiveMonth[];
  totalCount: number;
}

const archiveData = new Map<number, Map<number, ArchiveMonth>>();

// æœˆä»½åç§°
const monthNamesZh = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
const monthNamesEn = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
const monthNames = currentLocale === 'zh-CN' ? monthNamesZh : monthNamesEn;

allPosts.forEach(post => {
  // pubDate ç°åœ¨é€šè¿‡ schema transform ç»Ÿä¸€åŒ…å« date æˆ– pubDate çš„å€¼
  if (post.data.pubDate) {
    const date = new Date(post.data.pubDate);
    const year = date.getFullYear();
    const month = date.getMonth() + 1;

    if (!archiveData.has(year)) {
      archiveData.set(year, new Map());
    }

    const yearData = archiveData.get(year)!;

    if (!yearData.has(month)) {
      yearData.set(month, {
        month,
        monthName: monthNames[month - 1],
        count: 0,
        posts: []
      });
    }

    const monthData = yearData.get(month)!;
    monthData.count++;
    monthData.posts.push({
      id: post.id,
      title: post.data.title,
      pubDate: date
    });
  }
});

// è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
const archives: ArchiveYear[] = Array.from(archiveData.entries())
  .sort((a, b) => b[0] - a[0])
  .map(([year, monthsMap]) => {
    const months = Array.from(monthsMap.values())
      .sort((a, b) => b.month - a.month)
      .map(m => ({
        ...m,
        posts: m.posts.sort((a, b) => b.pubDate.getTime() - a.pubDate.getTime())
      }));

    return {
      year,
      months,
      totalCount: months.reduce((sum, m) => sum + m.count, 0)
    };
  });

const totalPosts = archives.reduce((sum, y) => sum + y.totalCount, 0);
---

<PageLayout
  title={ui.archives}
  description={ui.archives}
  showSidebar={true}
  i18nConfig={i18nConfig}
>
  <!-- é¢åŒ…å±‘å¯¼èˆª -->
  <nav class="flex items-center space-x-2 text-sm text-slate-600 dark:text-slate-400 mb-8">
    <a href={`${localePrefix}/`} class="hover:text-primary-500 transition-colors">{ui.home}</a>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
    </svg>
    <span class="text-slate-900 dark:text-slate-100">{ui.archives}</span>
  </nav>

  <!-- é¡µé¢å¤´éƒ¨ -->
  <div class="text-center mb-12">
    <div class="inline-flex items-center justify-center w-16 h-16 bg-primary-100 dark:bg-primary-900/30 rounded-full mb-4">
      <svg class="w-8 h-8 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>
    </div>

    <h1 class="text-4xl font-bold text-slate-900 dark:text-slate-100 mb-4">
      {ui.archives}
    </h1>

    <p class="text-xl text-slate-600 dark:text-slate-400">
      {totalPosts} {ui.posts} â€¢ {archives.length} {currentLocale === 'zh-CN' ? 'å¹´' : 'years'}
    </p>
  </div>

  <!-- å½’æ¡£æ—¶é—´çº¿ -->
  <div class="relative">
    <!-- æ—¶é—´çº¿ -->
    <div class="absolute left-4 md:left-8 top-0 bottom-0 w-0.5 bg-slate-200 dark:bg-slate-700"></div>

    {archives.map((yearData) => (
      <div class="mb-12">
        <!-- å¹´ä»½æ ‡é¢˜ -->
        <div class="relative flex items-center mb-6">
          <div class="absolute left-4 md:left-8 w-4 h-4 -ml-2 bg-primary-500 rounded-full border-4 border-white dark:border-slate-900 z-10"></div>
          <h2 class="ml-12 md:ml-16 text-2xl font-bold text-slate-900 dark:text-slate-100 flex items-center gap-3">
            {yearData.year}{currentLocale === 'zh-CN' ? 'å¹´' : ''}
            <span class="text-sm font-normal text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-800 px-3 py-1 rounded-full">
              {yearData.totalCount} {ui.posts}
            </span>
          </h2>
        </div>

        <!-- æœˆä»½åˆ—è¡¨ -->
        <div class="ml-12 md:ml-16 space-y-6">
          {yearData.months.map((monthData) => (
            <div class="relative">
              <!-- æœˆä»½èŠ‚ç‚¹ -->
              <div class="absolute -left-8 md:-left-8 w-2 h-2 mt-2 bg-slate-400 dark:bg-slate-500 rounded-full"></div>

              <div class="bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
                <!-- æœˆä»½æ ‡é¢˜ -->
                <a
                  href={`${localePrefix}/archives/${yearData.year}/${String(monthData.month).padStart(2, '0')}`}
                  class="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors"
                >
                  <span class="font-semibold text-slate-900 dark:text-slate-100">
                    {monthData.monthName}
                  </span>
                  <span class="text-sm text-slate-500 dark:text-slate-400 bg-white dark:bg-slate-700 px-2 py-1 rounded">
                    {monthData.count} {ui.posts}
                  </span>
                </a>

                <!-- æ–‡ç« åˆ—è¡¨é¢„è§ˆ -->
                <div class="divide-y divide-slate-100 dark:divide-slate-700">
                  {monthData.posts.slice(0, 5).map((post) => (
                    <a
                      href={`${localePrefix}/posts/${post.id.toLowerCase()}`}
                      class="flex items-center justify-between p-4 hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors"
                    >
                      <span class="text-slate-700 dark:text-slate-300 hover:text-primary-500 transition-colors line-clamp-1">
                        {post.title}
                      </span>
                      <time class="text-xs text-slate-500 dark:text-slate-400 ml-4 flex-shrink-0">
                        {post.pubDate.getDate()}{currentLocale === 'zh-CN' ? 'æ—¥' : ''}
                      </time>
                    </a>
                  ))}
                  {monthData.posts.length > 5 && (
                    <a
                      href={`${localePrefix}/archives/${yearData.year}/${String(monthData.month).padStart(2, '0')}`}
                      class="block p-4 text-center text-sm text-primary-500 hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors"
                    >
                      {currentLocale === 'zh-CN' ? `æŸ¥çœ‹å…¨éƒ¨ ${monthData.count} ç¯‡æ–‡ç« ` : `View all ${monthData.count} posts`} â†’
                    </a>
                  )}
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    ))}
  </div>

  <!-- ç©ºçŠ¶æ€ -->
  {archives.length === 0 && (
    <div class="text-center py-16">
      <div class="text-6xl mb-4">ğŸ“…</div>
      <h3 class="text-xl font-semibold text-slate-900 dark:text-slate-100 mb-2">
        {ui.noPostsFound}
      </h3>
      <p class="text-slate-600 dark:text-slate-400 mb-6">
        {currentLocale === 'zh-CN' ? 'è¿˜æ²¡æœ‰å‘å¸ƒä»»ä½•æ–‡ç« ' : 'No posts published yet'}
      </p>
      <a href={`${localePrefix}/`} class="btn-primary">
        {ui.home}
      </a>
    </div>
  )}
</PageLayout>

<style>
  .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
