---
import PageLayout from '@jet-w/astro-blog/layouts/PageLayout.astro';
import PostCard from '@jet-w/astro-blog/components/blog/PostCard.astro';
import Pagination from '@jet-w/astro-blog/components/ui/Pagination.astro';
import { getCollection } from 'astro:content';
import { i18nConfig as virtualI18nConfig } from 'virtual:astro-blog-i18n';
import { defaultI18nConfig } from '../../../config/i18n';
import { getLocaleFromPath, getLocaleConfig, getLocalePrefix, filterPostsByLocale } from '../../../utils/i18n';

export async function getStaticPaths() {
  const allPostsCollection = await getCollection('posts');
  const publishedPosts = allPostsCollection.filter(post => !post.data.draft);

  const postsPerPage = 10;
  const totalPages = Math.ceil(publishedPosts.length / postsPerPage);

  // ÁîüÊàê‰ªéÁ¨¨2È°µÂºÄÂßãÁöÑÊâÄÊúâÈ°µÈù¢Ë∑ØÂæÑÔºàÁ¨¨1È°µÁî± index.astro Â§ÑÁêÜÔºâ
  return Array.from({ length: totalPages - 1 }, (_, i) => ({
    params: { page: String(i + 2) },
  }));
}

const { page } = Astro.params;
const currentPage = parseInt(page as string, 10);

// Get i18n config
const i18nConfig = virtualI18nConfig || defaultI18nConfig;
const currentLocale = getLocaleFromPath(Astro.url.pathname, i18nConfig);
const localeConfig = getLocaleConfig(currentLocale, i18nConfig);
const ui = localeConfig.ui;
const base = import.meta.env.BASE_URL;
const localePrefix = getLocalePrefix(currentLocale, i18nConfig, base);

// ‰ªéÊñ∞ÁöÑÂÜÖÂÆπÁõÆÂΩïËé∑ÂèñÊñáÁ´†Êï∞ÊçÆ
const allPostsCollection = await getCollection('posts');

// Filter posts by current locale
const localeFilteredPosts = filterPostsByLocale(allPostsCollection, currentLocale, i18nConfig);

const publishedPosts = localeFilteredPosts
  .filter(post => !post.data.draft)
  .sort((a, b) => (b.data.pubDate?.getTime() ?? 0) - (a.data.pubDate?.getTime() ?? 0));

const allPosts = publishedPosts.map(post => ({
  slug: post.id.toLowerCase(),
  title: post.data.title,
  description: post.data.description,
  pubDate: post.data.pubDate,
  tags: post.data.tags,
  categories: post.data.categories,
  author: post.data.author,
  readingTime: 5,
  image: post.data.image
}));

// ÂàÜÈ°µÈÄªËæë
const postsPerPage = 10;
const totalPosts = allPosts.length;
const totalPages = Math.ceil(totalPosts / postsPerPage);
const startIndex = (currentPage - 1) * postsPerPage;
const endIndex = startIndex + postsPerPage;
const posts = allPosts.slice(startIndex, endIndex);

// Ëé∑ÂèñÊâÄÊúâÊ†áÁ≠æÂíåÂàÜÁ±ªÁî®‰∫éÁ≠õÈÄâ
const allTags = [...new Set(allPosts.flatMap(post => post.tags || []))];
const allCategories = [...new Set(allPosts.flatMap(post => post.categories || []))];
---

<PageLayout
  title={`${ui.postList} - ${ui.page} ${currentPage}`}
  description={localeConfig.site.description}
  showSidebar={true}
  i18nConfig={i18nConfig}
>
  <!-- Èù¢ÂåÖÂ±ëÂØºËà™ -->
  <nav class="flex items-center space-x-2 text-sm text-slate-600 dark:text-slate-400 mb-8">
    <a href={`${localePrefix}/`} class="hover:text-primary-500 transition-colors">{ui.home}</a>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
    </svg>
    <a href={`${localePrefix}/posts`} class="hover:text-primary-500 transition-colors">{ui.postList}</a>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
    </svg>
    <span class="text-slate-900 dark:text-slate-100">{ui.page} {currentPage}</span>
  </nav>

  <!-- È°µÈù¢Â§¥ÈÉ® -->
  <div class="mb-12">
    <div class="text-center">
      <h1 class="text-4xl font-bold text-slate-900 dark:text-slate-100 mb-4">
        {ui.postList}
      </h1>
      <p class="text-xl text-slate-600 dark:text-slate-400 mb-8">
        {localeConfig.site.description}
      </p>

      <!-- ÁªüËÆ°‰ø°ÊÅØ -->
      <div class="inline-flex items-center space-x-6 text-sm text-slate-500 dark:text-slate-400 bg-slate-50 dark:bg-slate-800 px-6 py-3 rounded-lg">
        <span>{totalPosts} {ui.posts}</span>
        <span>‚Ä¢</span>
        <span>{allTags.length} {ui.tags}</span>
        <span>‚Ä¢</span>
        <span>{allCategories.length} {ui.categories}</span>
      </div>
    </div>
  </div>

  <!-- Á≠õÈÄâÂô® -->
  <div class="mb-8 p-6 bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- ÊåâÊ†áÁ≠æÁ≠õÈÄâ -->
      <div>
        <h3 class="text-sm font-semibold text-slate-900 dark:text-slate-100 mb-3">
          {ui.filterByTag}
        </h3>
        <div class="flex flex-wrap gap-2">
          <a href={`${localePrefix}/tags`} class="px-3 py-1 text-xs rounded-full bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300 hover:bg-primary-200 dark:hover:bg-primary-900/50 transition-colors">
            {ui.allTags}
          </a>
          {allTags.slice(0, 10).map((tag) => (
            <a href={`${localePrefix}/tags/${tag.toLowerCase().replace(/\s+/g, '-')}`} class="px-3 py-1 text-xs rounded-full bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
              {tag}
            </a>
          ))}
          {allTags.length > 10 && (
            <a href={`${localePrefix}/tags`} class="px-3 py-1 text-xs rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
              +{allTags.length - 10}
            </a>
          )}
        </div>
      </div>

      <!-- ÊåâÂàÜÁ±ªÁ≠õÈÄâ -->
      <div>
        <h3 class="text-sm font-semibold text-slate-900 dark:text-slate-100 mb-3">
          {ui.filterByCategory}
        </h3>
        <div class="flex flex-wrap gap-2">
          <a href={`${localePrefix}/categories`} class="px-3 py-1 text-xs rounded-full bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300 hover:bg-primary-200 dark:hover:bg-primary-900/50 transition-colors">
            {ui.allCategories}
          </a>
          {allCategories.slice(0, 8).map((category) => (
            <a href={`${localePrefix}/categories/${category.toLowerCase().replace(/\s+/g, '-')}`} class="px-3 py-1 text-xs rounded-full bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
              {category}
            </a>
          ))}
          {allCategories.length > 8 && (
            <a href={`${localePrefix}/categories`} class="px-3 py-1 text-xs rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
              +{allCategories.length - 8}
            </a>
          )}
        </div>
      </div>
    </div>
  </div>

  <!-- ÊñáÁ´†ÂàóË°® -->
  {posts.length > 0 ? (
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-12">
      {posts.map((post) => (
        <PostCard post={post} layout="horizontal" localePrefix={localePrefix} locale={localeConfig.locale.dateLocale} ui={ui} />
      ))}
    </div>
  ) : (
    <div class="text-center py-16">
      <div class="text-6xl mb-4">üìù</div>
      <h3 class="text-xl font-semibold text-slate-900 dark:text-slate-100 mb-2">
        {ui.noPostsFound}
      </h3>
      <p class="text-slate-600 dark:text-slate-400">
        {ui.noPostsFound}
      </p>
    </div>
  )}

  <!-- ÂàÜÈ°µÂØºËà™ -->
  {totalPages > 1 && (
    <Pagination
      currentPage={currentPage}
      totalPages={totalPages}
      baseUrl={`${localePrefix}/posts`}
    />
  )}
</PageLayout>
