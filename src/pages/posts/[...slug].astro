---
import { getCollection, type CollectionEntry, render } from 'astro:content';
import PageLayout from '@jet-w/astro-blog/layouts/PageLayout.astro';
import SlidesLayout from '@jet-w/astro-blog/layouts/SlidesLayout.astro';
import FloatingToc from '@jet-w/astro-blog/components/blog/FloatingToc.vue';
import { i18nConfig as virtualI18nConfig } from 'virtual:astro-blog-i18n';
import { defaultI18nConfig } from '../../config/i18n';
import { getLocaleFromPath, getLocaleConfig, getLocalePrefix, removeBase } from '../../utils/i18n';

export async function getStaticPaths() {
  const posts = await getCollection('posts');

  // Build folder title map from README files (inline function)
  const folderTitles: Record<string, string> = {};
  posts.forEach(post => {
    const pathParts = post.id.split('/');
    const fileName = pathParts[pathParts.length - 1].toLowerCase();
    if (fileName === 'readme' || fileName === 'readme.md' || fileName === 'readme.mdx') {
      const folderPath = pathParts.slice(0, -1).join('/').toLowerCase();
      if (folderPath && post.data.title) {
        folderTitles[folderPath] = post.data.title;
      }
    }
  });

  // 按文件名称排序，readme.md 排在每个文件夹的最前面
  const sortedPosts = posts.sort((a, b) => {
    // 获取文件夹路径和文件名
    const aDir = a.id.includes('/') ? a.id.substring(0, a.id.lastIndexOf('/')) : '';
    const bDir = b.id.includes('/') ? b.id.substring(0, b.id.lastIndexOf('/')) : '';
    const aFile = a.id.includes('/') ? a.id.substring(a.id.lastIndexOf('/') + 1) : a.id;
    const bFile = b.id.includes('/') ? b.id.substring(b.id.lastIndexOf('/') + 1) : b.id;

    // 先按文件夹排序
    if (aDir !== bDir) {
      return aDir.localeCompare(bDir);
    }

    // 同一文件夹内，readme 排最前面
    const aIsReadme = aFile.toLowerCase() === 'readme' || aFile.toLowerCase() === 'readme.md';
    const bIsReadme = bFile.toLowerCase() === 'readme' || bFile.toLowerCase() === 'readme.md';

    if (aIsReadme && !bIsReadme) return -1;
    if (!aIsReadme && bIsReadme) return 1;

    // 其他文件按字母顺序排序
    return aFile.localeCompare(bFile);
  });

  // 收集所有目录路径
  const directories = new Set<string>();
  posts.forEach(post => {
    const parts = post.id.split('/');
    let currentPath = '';
    for (let i = 0; i < parts.length - 1; i++) {
      currentPath = currentPath ? `${currentPath}/${parts[i]}` : parts[i];
      directories.add(currentPath);
    }
  });

  // 定义路径类型
  type PathEntry = {
    params: { slug: string };
    props: {
      post: CollectionEntry<'posts'> | null;
      prevPost: CollectionEntry<'posts'> | null;
      nextPost: CollectionEntry<'posts'> | null;
      isDirectory: boolean;
      folderTitles: Record<string, string>;
    };
  };

  // 生成文章路径
  const paths: PathEntry[] = sortedPosts.map((post, index) => ({
    params: { slug: post.id.toLowerCase() },
    props: {
      post,
      prevPost: index > 0 ? sortedPosts[index - 1] : null,
      nextPost: index < sortedPosts.length - 1 ? sortedPosts[index + 1] : null,
      isDirectory: false,
      folderTitles,
    },
  }));

  // 生成目录路径（查找对应的 README）
  directories.forEach(dir => {
    const readmePost = posts.find(post => {
      const postId = post.id.toLowerCase();
      return postId === `${dir.toLowerCase()}/readme` ||
             postId === `${dir.toLowerCase()}/readme.md` ||
             postId === `${dir.toLowerCase()}/readme.mdx`;
    });

    // 只有当目录路径不与现有文章冲突时才添加
    const hasConflict = posts.some(post => post.id.toLowerCase() === dir.toLowerCase());
    if (!hasConflict) {
      paths.push({
        params: { slug: dir.toLowerCase() },
        props: {
          post: readmePost || null,
          prevPost: null,
          nextPost: null,
          isDirectory: true,
          folderTitles,
        },
      });
    }
  });

  return paths;
}

type Props = {
  post: CollectionEntry<'posts'> | null;
  prevPost: CollectionEntry<'posts'> | null;
  nextPost: CollectionEntry<'posts'> | null;
  isDirectory?: boolean;
  folderTitles: Record<string, string>;
};

// Build breadcrumb items for a post
function buildBreadcrumbItems(
  postId: string,
  postTitle: string,
  folderTitles: Record<string, string>
): Array<{ title: string; path: string; isLast: boolean }> {
  const parts = postId.toLowerCase().split('/');
  const items: Array<{ title: string; path: string; isLast: boolean }> = [];
  let currentPath = '';

  // Build breadcrumb for each folder level
  for (let i = 0; i < parts.length - 1; i++) {
    currentPath = currentPath ? `${currentPath}/${parts[i]}` : parts[i];
    const title = folderTitles[currentPath] || parts[i];
    items.push({ title, path: currentPath, isLast: false });
  }

  // Add the current post/file
  const fileName = parts[parts.length - 1];
  const isReadme = fileName === 'readme' || fileName === 'readme.md' || fileName === 'readme.mdx';

  if (!isReadme) {
    items.push({ title: postTitle, path: postId.toLowerCase(), isLast: true });
  } else if (items.length > 0) {
    items[items.length - 1].isLast = true;
  }

  return items;
}

const { post, prevPost, nextPost, isDirectory, folderTitles } = Astro.props;
const Content = post ? (await render(post)).Content : null;

// Get i18n config
const i18nConfig = virtualI18nConfig || defaultI18nConfig;
const base = import.meta.env.BASE_URL;

// Remove base URL from current path for locale detection
const pathWithoutBase = removeBase(Astro.url.pathname, base);

const currentLocale = getLocaleFromPath(pathWithoutBase, i18nConfig);
const localeConfig = getLocaleConfig(currentLocale, i18nConfig);
const ui = localeConfig.ui;
const localePrefix = getLocalePrefix(currentLocale, i18nConfig, base);

// Get the current slug from URL
const urlPath = Astro.url.pathname;
const postsMatch = urlPath.match(/\/posts\/(.+?)\/?$/);
const currentSlug = postsMatch ? postsMatch[1] : '';

// Build breadcrumb items
const breadcrumbItems = post
  ? buildBreadcrumbItems(post.id, post.data.title, folderTitles)
  : buildBreadcrumbItems(currentSlug, ui.documentTree, folderTitles);

// 判断是否使用 slides 布局
const isSlides = post?.data.layout === 'slides';

// 解析 Markdown 为幻灯片结构（当 layout: slides 时）
function parseSlides(markdown: string): string[][] {
  const cleanMarkdown = markdown
    .replace(/<!--[\s\S]*?-->/g, '')
    .trim();
  const horizontalSlides = cleanMarkdown.split(/\n---\n/);
  return horizontalSlides.map((hSlide) => {
    return hSlide.split(/\n----\n/).map(s => s.trim());
  });
}

const slidesData = isSlides && post?.body ? parseSlides(post.body) : [];

// 计算阅读时间（简单估算）
const readingTime = post ? Math.ceil((post.body?.length || 0) / 1000) : 0;

// 格式化日期（根据当前语言自动变化）
const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat(localeConfig.locale.dateLocale, {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(date);
};
---

{post && isSlides ? (
  <!-- Slides 布局 -->
  <SlidesLayout
    title={post.data.title}
    description={post.data.description}
    theme={post.data.theme}
    transition={post.data.transition}
    controls={post.data.controls}
    progress={post.data.progress}
    center={post.data.center}
    slideNumber={post.data.slideNumber}
  >
    {slidesData.map((verticalSlides) => (
      <section>
        {verticalSlides.map((slideContent) => (
          <section data-markdown>
            <textarea data-template set:text={slideContent}></textarea>
          </section>
        ))}
      </section>
    ))}
  </SlidesLayout>
) : post ? (
<PageLayout
  title={post.data.title}
  description={post.data.description}
  showSidebar={true}
  i18nConfig={i18nConfig}
>
  <!-- 面包屑导航 -->
  <nav class="flex items-center flex-wrap gap-y-1 text-sm text-slate-600 dark:text-slate-400 mb-8">
    <a href={`${localePrefix}/`} class="hover:text-primary-500 transition-colors">{ui.home}</a>
    {breadcrumbItems.map((item) => (
      <>
        <svg class="w-4 h-4 mx-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        {item.isLast ? (
          <span class="text-slate-900 dark:text-slate-100 truncate max-w-xs">{item.title}</span>
        ) : (
          <a href={`${localePrefix}/posts/${item.path}`} class="hover:text-primary-500 transition-colors">{item.title}</a>
        )}
      </>
    ))}
  </nav>

  <!-- 浮动目录 -->
  <FloatingToc
    client:load
    tocTitle={ui.tableOfContents}
    progressTitle={ui.readingProgress}
  />

  <!-- 文章头部 -->
  <article class="prose prose-slate dark:prose-invert max-w-none">
    <!-- 标题区域 -->
    <header class="not-prose mb-12">
      <div class="text-center">
        <h1 class="text-4xl md:text-5xl font-bold text-slate-900 dark:text-slate-100 mb-6 leading-tight">
          {post.data.title}
        </h1>

        <p class="text-xl text-slate-600 dark:text-slate-400 mb-8 max-w-3xl mx-auto">
          {post.data.description}
        </p>

        <!-- 文章元信息 -->
        <div class="flex flex-wrap items-center justify-center gap-6 text-sm text-slate-500 dark:text-slate-400">
          <div class="flex items-center space-x-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            <span>{post.data.author || '作者'}</span>
          </div>

          {post.data.pubDate && (
            <div class="flex items-center space-x-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <time datetime={post.data.pubDate.toISOString()}>
                {formatDate(post.data.pubDate)}
              </time>
            </div>
          )}

          <div class="flex items-center space-x-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>{readingTime} {ui.minuteRead}</span>
          </div>
        </div>

        <!-- 标签 -->
        {post.data.tags && post.data.tags.length > 0 && (
          <div class="flex flex-wrap justify-center gap-2 mt-6">
            {post.data.tags.map((tag) => (
              <a
                href={`${localePrefix}/tags/${tag.toLowerCase().replace(/\s+/g, '-')}`}
                class="px-3 py-1 text-xs font-medium bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300 rounded-full hover:bg-primary-200 dark:hover:bg-primary-900/50 transition-colors"
              >
                #{tag}
              </a>
            ))}
          </div>
        )}
      </div>

      <!-- 封面图片 -->
      {post.data.image && (
        <div class="mt-12 rounded-xl overflow-hidden">
          <img
            src={post.data.image}
            alt={post.data.title}
            class="w-full h-64 md:h-96 object-cover"
            loading="lazy"
          />
        </div>
      )}
    </header>

    <!-- 文章内容 -->
    <div class="prose prose-slate dark:prose-invert max-w-none prose-lg" data-prose-content data-locale-prefix={localePrefix} data-base-url={base}>
      {Content && <Content />}
    </div>

    <!-- 修复文章内容中的链接，添加当前语言前缀 -->
    <script is:inline>
      (function() {
        function fixProseLinks() {
          const proseContent = document.querySelector('[data-prose-content]');
          if (!proseContent) return;

          const localePrefix = proseContent.getAttribute('data-locale-prefix') || '';
          const baseUrl = proseContent.getAttribute('data-base-url') || '';

          // 如果没有 locale prefix 或 locale prefix 等于 base url，则不需要修复
          // 这意味着当前是默认语言
          if (!localePrefix || localePrefix === baseUrl) return;

          // 获取 locale 部分 (从 localePrefix 中提取，例如 /base/zh-CN -> zh-CN)
          const localePart = localePrefix.replace(baseUrl, '').replace(/^\//, '');
          if (!localePart) return;

          // 修复所有内部链接
          proseContent.querySelectorAll('a[href]').forEach(function(link) {
            const href = link.getAttribute('href');
            if (!href) return;

            // 跳过外部链接、锚点链接、mailto、tel 等
            if (href.startsWith('http://') ||
                href.startsWith('https://') ||
                href.startsWith('//') ||
                href.startsWith('#') ||
                href.startsWith('mailto:') ||
                href.startsWith('tel:') ||
                href.startsWith('data:')) {
              return;
            }

            // 跳过已经包含 locale 前缀的链接
            if (href.startsWith(localePrefix + '/') || href === localePrefix) {
              return;
            }

            // 对于以 baseUrl 开头但没有 locale 的链接，添加 locale
            if (baseUrl && href.startsWith(baseUrl + '/')) {
              const pathAfterBase = href.slice(baseUrl.length);
              // 检查是否已经有 locale 前缀
              if (!pathAfterBase.startsWith('/' + localePart + '/') && pathAfterBase !== '/' + localePart) {
                link.setAttribute('href', baseUrl + '/' + localePart + pathAfterBase);
              }
              return;
            }

            // 对于绝对路径链接 (以 / 开头)，添加 locale prefix
            if (href.startsWith('/')) {
              // 检查是否已经有 locale 前缀
              if (!href.startsWith('/' + localePart + '/') && href !== '/' + localePart) {
                link.setAttribute('href', localePrefix + href);
              }
            }
          });
        }

        // 页面加载后执行
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', fixProseLinks);
        } else {
          fixProseLinks();
        }

        // 支持 Astro 视图过渡
        document.addEventListener('astro:page-load', fixProseLinks);
      })();
    </script>

    <!-- 文章底部 -->
    <footer class="not-prose mt-16 pt-8 border-t border-slate-200 dark:border-slate-700">
      <!-- 分类信息 -->
      {post.data.categories && post.data.categories.length > 0 && (
        <div class="mb-8">
          <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100 mb-4">
            {ui.categories}
          </h3>
          <div class="flex flex-wrap gap-2">
            {post.data.categories.map((category) => (
              <a
                href={`${localePrefix}/categories/${category.toLowerCase().replace(/\s+/g, '-')}`}
                class="px-4 py-2 text-sm font-medium bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors"
              >
                {category}
              </a>
            ))}
          </div>
        </div>
      )}

      <!-- 更新时间 -->
      {post.data.updatedDate && post.data.updatedDate !== post.data.pubDate && (
        <div class="text-sm text-slate-500 dark:text-slate-400">
          最后更新：{formatDate(post.data.updatedDate)}
        </div>
      )}
    </footer>
  </article>

  <!-- 文章导航 -->
  <nav class="mt-16 pt-8 border-t border-slate-200 dark:border-slate-700">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- 上一篇 -->
      <div class="text-center md:text-left">
        <div class="text-sm text-slate-500 dark:text-slate-400 mb-2">{ui.previousPost}</div>
        {prevPost ? (
          <a
            href={`${localePrefix}/posts/${prevPost.id.toLowerCase()}`}
            class="group inline-flex items-center text-primary-500 hover:text-primary-600 dark:hover:text-primary-400 font-medium transition-colors"
          >
            <svg class="w-4 h-4 mr-2 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            <span class="line-clamp-1">{prevPost.data.title}</span>
          </a>
        ) : (
          <span class="text-slate-400 dark:text-slate-600">-</span>
        )}
      </div>

      <!-- 下一篇 -->
      <div class="text-center md:text-right">
        <div class="text-sm text-slate-500 dark:text-slate-400 mb-2">{ui.nextPost}</div>
        {nextPost ? (
          <a
            href={`${localePrefix}/posts/${nextPost.id.toLowerCase()}`}
            class="group inline-flex items-center justify-end text-primary-500 hover:text-primary-600 dark:hover:text-primary-400 font-medium transition-colors"
          >
            <span class="line-clamp-1">{nextPost.data.title}</span>
            <svg class="w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </a>
        ) : (
          <span class="text-slate-400 dark:text-slate-600">-</span>
        )}
      </div>
    </div>
  </nav>
</PageLayout>
) : (
<PageLayout
  title={ui.documentTree}
  description={ui.noPostsFound}
  showSidebar={true}
  i18nConfig={i18nConfig}
>
  <!-- 面包屑导航 -->
  <nav class="flex items-center flex-wrap gap-y-1 text-sm text-slate-600 dark:text-slate-400 mb-8">
    <a href={`${localePrefix}/`} class="hover:text-primary-500 transition-colors">{ui.home}</a>
    {breadcrumbItems.map((item) => (
      <>
        <svg class="w-4 h-4 mx-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        {item.isLast ? (
          <span class="text-slate-900 dark:text-slate-100 truncate max-w-xs">{item.title}</span>
        ) : (
          <a href={`${localePrefix}/posts/${item.path}`} class="hover:text-primary-500 transition-colors">{item.title}</a>
        )}
      </>
    ))}
  </nav>

  <div class="text-center py-16">
    <div class="inline-flex items-center justify-center w-20 h-20 bg-slate-100 dark:bg-slate-800 rounded-full mb-6">
      <svg class="w-10 h-10 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
      </svg>
    </div>
    <h1 class="text-2xl font-bold text-slate-900 dark:text-slate-100 mb-4">
      {ui.noPostsFound}
    </h1>
    <p class="text-slate-600 dark:text-slate-400 mb-8">
      {ui.noPostsFound}
    </p>
    <a href={`${localePrefix}/posts`} class="inline-flex items-center px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors">
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      {ui.postList}
    </a>
  </div>
</PageLayout>
)}