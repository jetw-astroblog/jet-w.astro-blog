---
/**
 * 首页最新文章组件
 */
import PostCard from '../../components/blog/PostCard.astro';
import { getCollection } from 'astro:content';
import type { I18nConfig } from '../../config/i18n';
import { defaultI18nConfig } from '../../config/i18n';
import { i18nConfig as virtualI18nConfig } from 'virtual:astro-blog-i18n';
import { getLocaleFromPath, getLocaleConfig, getLocalePrefix, filterPostsByLocale, removeBase } from '../../utils/i18n';

export interface Props {
  count?: number;
  i18nConfig?: I18nConfig;
}

const { count = 6, i18nConfig = virtualI18nConfig || defaultI18nConfig } = Astro.props;

// Get base URL for prefixing links
const base = import.meta.env.BASE_URL;

// Remove base URL from current path for locale detection
const pathWithoutBase = removeBase(Astro.url.pathname, base);

// Get current locale from URL (use path without base)
const currentLocale = getLocaleFromPath(pathWithoutBase, i18nConfig);
const localeConfig = getLocaleConfig(currentLocale, i18nConfig);
const ui = localeConfig.ui;
const localePrefix = getLocalePrefix(currentLocale, i18nConfig, base);

const allPosts = await getCollection('posts');
const publishedPosts = allPosts
  .filter(post => !post.data.draft)
  .sort((a, b) => (b.data.pubDate?.getTime() ?? 0) - (a.data.pubDate?.getTime() ?? 0));

// Filter posts by current locale
const localePosts = filterPostsByLocale(publishedPosts, currentLocale, i18nConfig);

const recentPosts = localePosts.slice(0, count).map(post => ({
  slug: post.id.toLowerCase(),
  title: post.data.title,
  description: post.data.description,
  pubDate: post.data.pubDate,
  tags: post.data.tags,
  categories: post.data.categories,
  author: post.data.author,
  readingTime: 5
}));

const postsUrl = `${localePrefix}/posts`;
---

<section class="mb-16">
  <div class="flex items-center justify-between mb-8">
    <h2 class="text-2xl font-bold text-slate-900 dark:text-slate-100">
      {ui.recentPosts}
    </h2>
    <a
      href={postsUrl}
      class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400 font-medium text-sm flex items-center space-x-1 transition-colors"
    >
      <span>{ui.allPosts}</span>
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
    </a>
  </div>

  <div class="space-y-6">
    {recentPosts.map((post) => (
      <PostCard post={post} layout="horizontal" localePrefix={localePrefix} locale={localeConfig.locale.dateLocale} ui={{ readMore: ui.readMore, minuteRead: ui.minuteRead }} />
    ))}
  </div>
</section>
