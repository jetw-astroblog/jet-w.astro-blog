---
import { siteConfig } from '@jet-w/astro-blog/config';
import ThemeToggle from '../ui/ThemeToggle.vue';
import SearchBox from '../ui/SearchBox.vue';
import MobileMenu from '../ui/MobileMenu.vue';
import LanguageSwitcher from '../ui/LanguageSwitcher.vue';
import type { I18nConfig } from '../../config/i18n';
import { defaultI18nConfig } from '../../config/i18n';
import { i18nConfig as virtualI18nConfig } from 'virtual:astro-blog-i18n';
import {
  getLocaleFromPath,
  getLocaleConfig,
  removeLocalePrefix,
  removeBase,
  isMultiLanguageEnabled,
  withBase,
} from '../../utils/i18n';

export interface Props {
  i18nConfig?: I18nConfig;
}

const { i18nConfig = virtualI18nConfig || defaultI18nConfig } = Astro.props;

const currentPath = Astro.url.pathname;

// Get base URL for prefixing links
const base = import.meta.env.BASE_URL;

// Get base path without base URL - needed for locale detection
const pathWithoutBase = removeBase(currentPath, base);

// Detect current locale from path (without base URL)
const currentLocale = getLocaleFromPath(pathWithoutBase, i18nConfig);
const localeConfig = getLocaleConfig(currentLocale, i18nConfig);
const ui = localeConfig.ui;

// Use locale-specific site config and menu
const localeSiteConfig = localeConfig.site;
const menu = localeConfig.menu;

// Get path without locale prefix for language switcher
const pathWithoutLocale = removeLocalePrefix(pathWithoutBase, i18nConfig);

// Check if multi-language is enabled
const showLanguageSwitcher = isMultiLanguageEnabled(i18nConfig);

// Prepare locales for language switcher
const localesForSwitcher = i18nConfig.locales.map(l => ({
  code: l.code,
  name: l.name,
}));
---

<header class="sticky top-0 z-50 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm border-b border-slate-200 dark:border-slate-700 w-full">
  <div class="w-full px-4">
    <nav class="relative flex items-center justify-between h-16">
      <!-- 左侧：图标和标题 -->
      <div class="flex items-center space-x-4">
        <a href={withBase('/', base)} class="flex items-center space-x-3 hover:opacity-80 transition-opacity">
          {(localeSiteConfig.avatar || siteConfig.avatar) && (
            <img
              src={withBase(localeSiteConfig.avatar || siteConfig.avatar || '', base)}
              alt={localeSiteConfig.title || siteConfig.title}
              class="w-8 h-8 rounded-full"
            />
          )}
          <div class="hidden sm:block">
            <h1 class="text-xl font-bold text-slate-900 dark:text-slate-100">
              {localeSiteConfig.title ?? siteConfig.title}
            </h1>
            {(localeSiteConfig.description ?? siteConfig.description) && (
              <p class="text-xs text-slate-600 dark:text-slate-400 -mt-1">
                {localeSiteConfig.description ?? siteConfig.description}
              </p>
            )}
          </div>
        </a>
      </div>

      <!-- 中间：导航菜单（桌面端显示） -->
      <div class="hidden lg:flex absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2">
        <div class="flex items-center space-x-8">
          {menu.map((item) => (
            <a
              href={withBase(item.href, base)}
              class={`text-sm font-medium transition-colors hover:text-primary-500 ${
                currentPath === withBase(item.href, base) || (item.href !== '/' && currentPath.startsWith(withBase(item.href, base)))
                  ? 'text-primary-500'
                  : 'text-slate-700 dark:text-slate-300'
              }`}
            >
              {item.name}
            </a>
          ))}
        </div>
      </div>

      <!-- 右侧：搜索、语言切换、主题切换（桌面端）+ 菜单按钮（移动端） -->
      <div class="flex items-center space-x-2">
        <!-- 桌面端显示 -->
        <div class="hidden lg:block">
          <SearchBox
            client:load
            placeholder={ui.searchPlaceholder}
            searchLabel={ui.search}
            noResultsText={ui.noResults}
          />
        </div>

        {showLanguageSwitcher && (
          <div class="hidden lg:block">
            <LanguageSwitcher
              client:load
              locales={localesForSwitcher}
              currentLocale={currentLocale}
              currentPath={pathWithoutLocale}
              defaultLocale={i18nConfig.defaultLocale}
              prefixDefaultLocale={i18nConfig.routing.prefixDefaultLocale}
              base={base}
            />
          </div>
        )}

        <div class="hidden lg:block">
          <ThemeToggle client:load />
        </div>

        <!-- 移动端显示菜单按钮 -->
        <div class="lg:hidden">
          <MobileMenu
            client:load
            navigation={menu}
            base={base}
          />
        </div>
      </div>
    </nav>
  </div>
</header>
